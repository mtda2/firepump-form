<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบอัจฉริยะ Fire Pump & Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Sarabun', sans-serif; scroll-behavior: smooth; }
        body { background-color: #f0f4f8; }
        .theme-header { background-color: #1e293b; }
        .theme-accent { color: #14b8a6; }
        .theme-accent-radio { accent-color: #14b8a6; }
        .radio-item:has(input[type="radio"]:checked),
        .radio-item-other:has(input[type="radio"]:checked) {
            background-color: #f0fdfa; border-color: #14b8a6;
            box-shadow: 0 0 0 2px hsla(173, 82%, 41%, 0.3);
        }
        dialog { transition: opacity 0.3s ease-out, transform 0.3s ease-out; }
        dialog[open] { opacity: 1; transform: scale(1); }
        dialog::backdrop {
            background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(8px);
            transition: opacity 0.3s ease-out, backdrop-filter 0.3s ease-out;
        }
        .spinner { border: 3px solid #e2e8f0; border-top: 3px solid #14b8a6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn {
            transition: all 0.2s ease-in-out; border-radius: 0.5rem; font-weight: 600;
            padding: 0.75rem 1.5rem; display: inline-flex; align-items: center;
            justify-content: center; gap: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1); }
        .btn-ai { background-color: #14b8a6; color: white; }
        .btn-ai:hover { background-color: #0d9488; }
        .btn-submit { background-color: #4338ca; color: white; }
        .btn-submit:hover { background-color: #3730a3; }
        .btn-preview { background-color: #e2e8f0; color: #1e293b; }
        .btn-preview:hover { background-color: #cbd5e1; }
        .btn-reset { background-color: #be123c; color: white; }
        .btn-reset:hover { background-color: #9f1239; }
        .form-input { border: 1px solid #cbd5e1; border-radius: 0.5rem; transition: all 0.2s ease; }
        .form-input:focus { outline: none; border-color: #14b8a6; box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.3); }
        .input-ok { border-color: #10b981 !important; background-color: #ecfdf5 !important; }
        .input-warning { border-color: #f59e0b !important; background-color: #fffbeb !important; }
        .input-critical { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        #loginDialog { max-width: 400px; border-radius: 1rem; overflow: hidden; border: none; padding: 0; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); }
        .label-required::after { content: ' *'; color: #ef4444; }
        .helper-text { font-size: 0.875rem; color: #64748b; margin-bottom: 8px; }
        .cute-mechanic-img {
            max-width: 120px; margin: -80px auto 1.5rem; display: block; background: white;
            border-radius: 50%; padding: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            position: relative; z-index: 10;
        }
    </style>
</head>
<body>

    <dialog id="loginDialog">
        <div class="p-8 text-center bg-slate-700 text-white">
            <i class="fa-solid fa-shield-halved text-5xl mb-3 text-teal-400"></i>
            <h2 class="text-3xl font-bold">Maintenance Access</h2>
            <p class="opacity-80">โปรดลงชื่อเข้าสู่ระบบ</p>
        </div>
        <div class="p-8 bg-white">
            <img src="mechanic.png" alt="Cute Mechanic" class="cute-mechanic-img">
            <form id="loginForm">
                <div class="mb-4">
                    <input type="text" id="username" name="username" class="form-input w-full p-3 text-lg" placeholder="ชื่อผู้ใช้" required>
                </div>
                <div class="mb-5">
                    <input type="password" id="password" name="password" class="form-input w-full p-3 text-lg" placeholder="รหัสผ่าน" required>
                </div>
                <button type="submit" id="loginButton" class="btn bg-teal-500 text-white w-full text-base hover:bg-teal-600">
                    <i class="fa-solid fa-arrow-right-to-bracket"></i>
                    <span>เข้าสู่ระบบ</span>
                </button>
                <p id="loginError" class="text-red-600 text-center font-semibold h-5 mt-3 text-sm"></p>
            </form>
        </div>
    </dialog>
    
    <div id="mainContent" class="hidden">
        <div class="theme-header text-white py-8 mb-8 shadow-xl">
            <div class="container mx-auto px-4 text-center">
                 <h1 class="text-4xl font-bold tracking-wide"><i class="fa-solid fa-fire-extinguisher theme-accent mr-3"></i>ระบบทดสอบเครื่องยนต์สูบน้ำดับเพลิง</h1>
            </div>
        </div>

        <div class="container mx-auto px-4">
            <div class="text-center mb-6 bg-white p-4 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-slate-800">แผนกช่างซ่อมบำรุง โรงพยาบาลเอกชล 2</h2>
            </div>
            
            <form id="inspectionForm" action="https://docs.google.com/forms/d/e/1FAIpQLSdAp3uUyN7l7SGrMYEp0eCQpxkRd-iMnltaFEhAaLZKvQJF-w/formResponse" method="POST" target="hidden_iframe">
                
                <div class="sticky bottom-0 z-10 py-4 mt-8 bg-white/90 backdrop-blur-sm rounded-t-2xl shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.1)]">
                    <div class="container mx-auto px-4 flex flex-wrap justify-center items-center gap-4">
                        <button type="button" id="analyzeButton" class="btn btn-ai"><i class="fa-solid fa-robot"></i><span>วิเคราะห์ด้วย AI "เมฆา"</span></button>
                        <button type="button" id="previewButton" class="btn btn-preview"><i class="fa-solid fa-magnifying-glass"></i><span>ตรวจสอบคำตอบ</span></button>
                        <button type="submit" class="btn btn-submit"><i class="fa-solid fa-paper-plane"></i><span>ส่งรายงาน</span></button>
                        <button type="button" id="resetButton" class="btn btn-reset"><i class="fa-solid fa-arrow-rotate-left"></i><span>รีเซ็ตฟอร์ม</span></button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="handleFormSubmitted()"></iframe>

    <dialog id="previewDialog" class="rounded-2xl shadow-xl p-0 w-11/12 max-w-2xl"></dialog>
    <dialog id="aiDialog" class="rounded-2xl shadow-xl p-0 w-11/12 max-w-3xl"></dialog>

    <script>
    // These functions MUST be global for the iframe `onload` to find them.
    let formSubmitted = false;
    function handleFormSubmitted() {
        if (formSubmitted) {
            alert('ส่งรายงานสำเร็จ!');
            const submitButton = document.querySelector('#inspectionForm button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fa-solid fa-paper-plane"></i><span>ส่งรายงาน</span>';
            }
            // Use the reset function exposed on the window object
            if (window.app && typeof window.app.resetForm === 'function') {
                window.app.resetForm(true);
            }
            formSubmitted = false;
        }
    }

    // Wrap all application logic in a DOMContentLoaded event listener
    document.addEventListener('DOMContentLoaded', function() {
        // --- PRE-FLIGHT CHECK ---
        if (window.location.protocol === 'file:') {
            alert('ข้อผิดพลาด: ไฟล์นี้ต้องถูกรันผ่านเว็บเซิร์ฟเวอร์ (เช่น Live Server) ไม่สามารถเปิดโดยตรงได้ ระบบล็อกอินจะไม่ทำงาน');
            document.body.innerHTML = `<div style="padding: 2rem; text-align: center; font-size: 1.2rem; color: red;">กรุณาเปิดไฟล์นี้ผ่านเว็บเซิร์ฟเวอร์</div>`;
            return;
        }

        // --- CONSTANTS & STATE ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpKavLhCGZTy1v4StlAdAEQIHDhD92oWngAxzHFDPkxaGTN9AyayPtL0vO4gyqxkL2qw/exec";
        
        // --- ELEMENT SELECTORS ---
        const loginDialog = document.getElementById('loginDialog');
        const loginForm = document.getElementById('loginForm');
        const mainContent = document.getElementById('mainContent');
        const inspectionForm = document.getElementById('inspectionForm');

        // ===================================
        // INITIALIZATION
        // ===================================
        
        function initializeLogin() {
            console.log("Initializing Login System...");
            if (!loginDialog || !loginForm) {
                console.error("Login elements not found!");
                return;
            }

            loginDialog.showModal();
            loginDialog.addEventListener('cancel', (e) => e.preventDefault());

            loginForm.addEventListener('submit', handleLoginSubmit);
        }

        function initializeMainForm() {
            console.log("Initializing Main Form...");
            if (!inspectionForm) {
                console.error("Main form element not found!");
                return;
            }
            
            autoFillCurrentDate();
            
            // --- Attach Event Listeners ---
            inspectionForm.addEventListener('submit', handleMainFormSubmit);
            document.getElementById('analyzeButton').addEventListener('click', analyzeWithAI);
            document.getElementById('previewButton').addEventListener('click', previewAnswers);
            document.getElementById('resetButton').addEventListener('click', () => resetForm(false));
            
            // Use event delegation for dynamic elements
            inspectionForm.addEventListener('click', handleFormClicks);
            inspectionForm.addEventListener('input', handleFormInputs);
        }

        // ===================================
        // EVENT HANDLERS
        // ===================================

        async function handleLoginSubmit(e) {
            e.preventDefault();
            const loginButton = document.getElementById('loginButton');
            const loginError = document.getElementById('loginError');
            
            loginError.textContent = '';
            loginButton.innerHTML = '<div class="spinner"></div><span class="ml-2">กำลังตรวจสอบ...</span>';
            loginButton.disabled = true;

            const username = loginForm.username.value;
            const password = loginForm.password.value;

            try {
                console.log("Attempting to fetch login data from Apps Script...");
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);

                const result = await response.json();
                console.log("Received response from Apps Script:", result);

                if (result.success) {
                    console.log("Login successful.");
                    loginDialog.close();
                    mainContent.classList.remove('hidden');
                    initializeMainForm();
                } else {
                    console.warn("Login failed:", result.message);
                    loginError.textContent = result.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
                }
            } catch (error) {
                console.error("Login fetch failed:", error);
                loginError.textContent = 'ไม่สามารถเชื่อมต่อได้ โปรดตรวจสอบ Console (F12)';
            } finally {
                loginButton.innerHTML = '<i class="fa-solid fa-arrow-right-to-bracket"></i><span>เข้าสู่ระบบ</span>';
                loginButton.disabled = false;
            }
        }

        function handleMainFormSubmit(e) {
            e.preventDefault();
            const submitButton = inspectionForm.querySelector('button[type="submit"]');
            formSubmitted = true;
            submitButton.disabled = true;
            submitButton.innerHTML = '<div class="spinner"></div><span class="ml-2">กำลังส่ง...</span>';
            inspectionForm.submit();
        }

        function handleFormClicks(e) {
            const radioContainer = e.target.closest('.radio-item, .radio-item-other');
            if (radioContainer) {
                selectRadio(radioContainer);
            }
        }

        function handleFormInputs(e) {
            if (e.target.matches('input[type="number"][placeholder*="STD."]')) {
                validateInput(e.target);
            }
        }
        
        // ===================================
        // HELPER FUNCTIONS
        // ===================================

        function autoFillCurrentDate() {
            const dateInput = inspectionForm.querySelector('input[name="entry.1632403651"]');
            if (dateInput) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            }
        }

        function selectRadio(element) {
            const radio = element.querySelector('input[type="radio"]');
            if (radio && !radio.checked) {
                radio.checked = true;
                
                const parentGroup = element.closest('.grid, .radio-group');
                if (parentGroup) {
                    parentGroup.querySelectorAll('.other-input').forEach(input => input.classList.add('hidden'));
                }
                
                if (element.classList.contains('radio-item-other')) {
                    const otherInput = element.querySelector('.other-input');
                    if (otherInput) {
                        otherInput.classList.remove('hidden');
                        otherInput.focus();
                    }
                }
            }
        }

        function resetForm(force = false) {
            if (force || confirm('คุณต้องการล้างข้อมูลในฟอร์มทั้งหมดใช่หรือไม่?')) {
                inspectionForm.reset();
                document.querySelectorAll('.other-input').forEach(input => input.classList.add('hidden'));
                document.querySelectorAll('.input-ok, .input-warning, .input-critical').forEach(el => {
                    el.classList.remove('input-ok', 'input-warning', 'input-critical');
                });
                autoFillCurrentDate();
            }
        }
        // Expose resetForm globally for the iframe handler
        window.app = { resetForm };
        
        // All other functions (previewAnswers, validateInput, analyzeWithAI, generateAiAnalysis) are unchanged
        // and can be placed here. For brevity in this explanation, they are assumed to be present.
        // ... [The full code for previewAnswers, validateInput, and AI analysis follows] ...
        function previewAnswers() {
            const dialog = document.getElementById('previewDialog');
            let contentHTML = '';
            const formData = new FormData(inspectionForm);
            let count = 0;
            const labelMap = new Map();

            inspectionForm.querySelectorAll('.form-group').forEach(group => {
                const label = group.querySelector('.form-label');
                if (label) {
                    group.querySelectorAll('input, textarea').forEach(input => {
                        if (input.name) labelMap.set(input.name, label.textContent.split('/')[0].trim());
                    });
                }
            });

            contentHTML += '<ul class="list-none space-y-3">';
            for (const [name, value] of formData.entries()) {
                if (value && value !== '__other_option__') {
                    let labelText = labelMap.get(name) || name;
                    if (name.includes('.other_option_response')) {
                        const baseName = name.replace('.other_option_response', '');
                        labelText = (labelMap.get(baseName) || baseName) + " (อื่นๆ)";
                    }
                    contentHTML += `<li class="border-b pb-2"><strong class="text-indigo-600">${labelText}:</strong><br><span class="pl-2">${value}</span></li>`;
                    count++;
                }
            }
            contentHTML += '</ul>';

            if (count === 0) {
                contentHTML = '<p class="text-center text-gray-500">ยังไม่มีการกรอกข้อมูล</p>';
            }

            dialog.innerHTML = `<div class="p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h2 class="text-2xl font-bold theme-accent">พรีวิวคำตอบ</h2>
                    <button onclick="this.closest('dialog').close()" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
                </div>
                <div id="previewContent" class="space-y-2 text-gray-700 max-h-[70vh] overflow-y-auto">${contentHTML}</div>
            </div>`;
            dialog.showModal();
        }

        function validateInput(element) {
            const value = parseFloat(element.value);
            const placeholder = element.placeholder || '';
            
            element.classList.remove('input-ok', 'input-warning', 'input-critical');
            if (isNaN(value)) return;

            let match = placeholder.match(/(\d+)\s*-\s*(\d+)/);
            if (match) {
                const min = parseFloat(match[1]);
                const max = parseFloat(match[2]);
                if (value >= min && value <= max) element.classList.add('input-ok');
                else element.classList.add('input-critical');
                return;
            }

            match = placeholder.match(/ไม่ต่ำกว่า\s*([\d.]+)/);
            if (match) {
                const min = parseFloat(match[1]);
                if (value >= min) element.classList.add('input-ok');
                else if (value >= min * 0.9) element.classList.add('input-warning');
                else element.classList.add('input-critical');
                return;
            }

            match = placeholder.match(/([\d,]+)/);
            if (match) {
                const std = parseFloat(match[1].replace(/,/g, ''));
                const tolerance = 0.10;
                if (Math.abs(value - std) <= std * tolerance) element.classList.add('input-ok');
                else if (Math.abs(value - std) <= std * (tolerance + 0.05)) element.classList.add('input-warning');
                else element.classList.add('input-critical');
            }
        }

        function analyzeWithAI() {
            const dialog = document.getElementById('aiDialog');
            dialog.innerHTML = `<div class="p-6 md:p-8 bg-slate-50">
                <div class="flex justify-between items-start border-b border-slate-200 pb-4 mb-5">
                    <div class="flex items-center gap-4">
                        <img src="ai_avatar.png" alt="AI Avatar Mekha" class="w-16 h-16 bg-white p-1 rounded-full shadow-lg border-2 theme-accent-border">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">AI Engineer "เมฆา"</h2>
                            <p class="text-slate-500">ผลการวิเคราะห์ข้อมูลเชิงลึก 🧠</p>
                        </div>
                    </div>
                    <button onclick="this.closest('dialog').close()" class="text-3xl text-slate-400 hover:text-slate-600 transition-colors">&times;</button>
                </div>
                <div id="aiLoading" class="text-center py-10">
                    <div class="pulse-loader mx-auto"><div></div><div></div><div></div></div>
                    <p class="text-slate-500 mt-4 font-semibold">กำลังประมวลผลข้อมูล... กรุณารอสักครู่</p>
                </div>
                <div id="aiResult" class="hidden space-y-4 max-h-[70vh] overflow-y-auto p-1"></div>
            </div>`;

            const loadingDiv = document.getElementById('aiLoading');
            const resultDiv = document.getElementById('aiResult');
            
            loadingDiv.style.display = 'block';
            resultDiv.classList.add('hidden');
            dialog.showModal();

            const formData = new FormData(inspectionForm);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (key.includes('.other_option_response')) {
                    const baseKey = key.replace('.other_option_response', '');
                    if (data[baseKey] === '__other_option__') {
                        data[baseKey] = value;
                    }
                } else if (value) {
                    data[key] = value;
                }
            }

            setTimeout(() => {
                const analysisHTML = generateAiAnalysis(data);
                resultDiv.innerHTML = analysisHTML;
                loadingDiv.style.display = 'none';
                resultDiv.classList.remove('hidden');
            }, 1500);
        }
        
        function generateAiAnalysis(data) {
            // This entire function is complex but self-contained. No changes needed.
            // It is kept as is.
            let results = { critical: new Set(), warning: new Set(), ok: new Set(), info: new Set() };
            const getLabel = (name) => {
                const el = document.querySelector(`[name="${name}"]`);
                if (!el) return name;
                const formGroup = el.closest('.form-group');
                return (formGroup && formGroup.querySelector('.form-label')) ? formGroup.querySelector('.form-label').textContent.split('/')[0].trim() : name;
            };

            const rules = {
                'entry.1618028324': { label: 'ระดับน้ำมันหล่อลื่น', type: 'radio', conditions: { 'ต่ำ': { severity: 'critical', msg: 'ต่ำกว่าเกณฑ์ อาจสร้างความเสียหายร้ายแรงต่อเครื่องยนต์ ควรเติมทันทีตามสเปคผู้ผลิต' } } },
                'entry.14334317': { label: 'ระดับน้ำระบายความร้อน', type: 'radio', conditions: { 'ต่ำ': { severity: 'critical', msg: 'ต่ำกว่าเกณฑ์ อาจทำให้เครื่องยนต์ร้อนจัด (Overheat) ควรเติมน้ำยาหล่อเย็นให้อยู่ในระดับที่เหมาะสม' } } },
                'entry.1091386807': { label: 'ระดับน้ำกลั่นแบตเตอรี่', type: 'radio', conditions: { 'ต่ำ': { severity: 'warning', msg: 'ต่ำกว่าเกณฑ์ ควรเติมน้ำกลั่นเพื่อรักษาประสิทธิภาพและยืดอายุการใช้งานแบตเตอรี่' } } },
                'entry.964120987': { label: 'ระดับเชื้อเพลิง', type: 'numeric', conditions: { check: (val) => val < 50, severity: 'warning', msg: (val) => `มีเชื้อเพลิง ${val} ลิตร ซึ่งอาจไม่เพียงพอต่อการใช้งานฉุกเฉินเป็นเวลานาน แนะนำให้เติมเชื้อเพลิงให้พร้อมใช้อยู่เสมอ (ไม่ต่ำกว่า 75% ของถัง)` } },
                'entry.323305993': { label: 'การรั่วไหลของน้ำมันเชื้อเพลิง', type: 'radio', conditions: { 'รั่วไหล': { severity: 'critical', msg: 'พบการรั่วไหล เป็นอันตรายร้ายแรง เสี่ยงต่อการเกิดอัคคีภัย ต้องหยุดใช้งานและซ่อมแซมทันที' } } },
                'entry.1072480311': { label: 'การรั่วไหลของน้ำมันหล่อลื่น', type: 'radio', conditions: { 'รั่วไหล': { severity: 'critical', msg: 'พบการรั่วไหล ต้องรีบตรวจสอบและแก้ไขเพื่อป้องกันความเสียหายต่อส่วนประกอบภายในเครื่องยนต์' } } },
                'entry.1607591057': { label: 'การรั่วไหลของน้ำระบายความร้อน', type: 'radio', conditions: { 'รั่วไหล': { severity: 'critical', msg: 'พบการรั่วไหล อาจทำให้เครื่องยนต์ Overheat และเสียหายรุนแรงได้ ต้องรีบหาจุดรั่วและซ่อมแซม' } } },
                'entry.719816448': { label: 'สภาพของสลักและน๊อต', type: 'radio', conditions: { 'น็อตไม่แน่น': { severity: 'warning', msg: 'ตรวจพบสลักและน็อตหลวม อาจเป็นสาเหตุของการสั่นสะเทือนที่ผิดปกติและทำให้ชิ้นส่วนอื่นเสียหายตามมา ควรกวดขันให้แน่น' } } },
                'entry.737194412': { label: 'สภาพของขั้วต่อสายไฟฟ้า', type: 'radio', conditions: { 'ขั้วสายไม่แน่น': { severity: 'warning', msg: 'ขั้วต่อสายไฟฟ้าหลวม อาจเป็นสาเหตุของความร้อนสะสม, แรงดันตก, หรือการทำงานผิดพลาดของระบบไฟฟ้า ควรกวดขันให้แน่น' } } },
                'entry.1182164809': { label: 'ไส้กรองอากาศ', type: 'radio', conditions: { 'ไส้กรองตัน': { severity: 'warning', msg: 'ตัน ทำให้ส่วนผสมอากาศกับน้ำมันไม่สมบูรณ์ ส่งผลให้เครื่องยนต์กำลังตก, สิ้นเปลืองเชื้อเพลิง, และเกิดควันดำ ควรทำความสะอาดหรือเปลี่ยนใหม่' } } },
                'entry.950885152': { label: 'ไส้กรองน้ำมัน', type: 'radio', conditions: { 'ตัน': { severity: 'warning', msg: 'ตัน อาจทำให้แรงดันเชื้อเพลิงตก, เครื่องยนต์เดินไม่เรียบ หรือสตาร์ทติดยาก ควรเปลี่ยนตามรอบการบำรุงรักษา' } } },
                'entry.170318696': { label: 'แรงดันปั๊มเริ่มทำงาน', type: 'numeric', tolerance: 0.1, std: 100, msg: (val, std) => `มีค่า ${val} PSI ซึ่งอยู่นอกเกณฑ์มาตรฐาน (${std} PSI ±10%) ควรตรวจสอบ Pressure Switch ของ Jocky Pump` },
                'entry.835390568': { label: 'แรงดันปั๊มหยุดทำงาน', type: 'numeric_range', min: 120, max: 130, msg: (val, min, max) => `มีค่า ${val} PSI ซึ่งอยู่นอกเกณฑ์มาตรฐาน (${min}-${max} PSI) ควรตรวจสอบและปรับตั้ง Pressure Switch` },
                'entry.1405771031': { label: 'ความเร็วรอบเครื่องยนต์', type: 'numeric', tolerance: 0.1, std: 2300, msg: (val, std) => `มีค่า ${val} RPM ซึ่งอยู่นอกเกณฑ์มาตรฐาน (${std} RPM ±10%) อาจต้องปรับจูนเครื่องยนต์` },
                'entry.1301900075': { label: 'แรงดันน้ำมันหล่อลื่น', type: 'numeric_range', min: 250, max: 750, msg: (val, min, max) => `มีค่า ${val} Kpa อยู่นอกเกณฑ์ (${min}-${max} Kpa) เป็นอันตรายต่อเครื่องยนต์ ต้องหยุดและตรวจสอบทันที` },
                'entry.1127101964': { label: 'อุณภูมิน้ำระบายความร้อน', type: 'numeric_range', min: 80, max: 100, msg: (val, min, max) => `มีค่า ${val}°C สูง/ต่ำกว่าเกณฑ์ (${min}-${max}°C) ควรตรวจสอบระบบระบายความร้อน` },
                'entry.797055912': { label: 'แรงดันเครื่องยนต์เริ่มทำงาน', type: 'numeric', tolerance: 0.1, std: 99, msg: (val, std) => `มีค่า ${val} PSI ซึ่งอยู่นอกเกณฑ์ (${std} PSI ±10%) อาจต้องปรับตั้ง Pressure Switch ของ Fire Pump` },
                'entry.1506477567': { label: 'แรงดันขณะเครื่องยนต์ทำงาน', type: 'numeric', tolerance: 0.1, std: 120, msg: (val, std) => `มีค่า ${val} PSI ซึ่งต่ำกว่าเกณฑ์ (${std} PSI ±10%) อาจบ่งชี้ถึงปัญหากำลังอัดของปั๊มหรือมีจุดรั่วในระบบ` },
                'entry.628997006': { label: 'การสั่นของเครื่องยนต์', type: 'radio', conditions: { 'ผิดปกติ(เครื่องสั่นมาก)': { severity: 'critical', msg: 'สั่นผิดปกติรุนแรง อาจเกิดจากแท่นเครื่องชำรุด, ระบบจุดระเบิด/จ่ายน้ำมันผิดพลาด หรือความไม่สมดุลของเพลา ควรให้ช่างผู้ชำนาญตรวจสอบโดยละเอียด' } } },
                'entry.1209254361': { label: 'ความผิดปกติของเสียง', type: 'radio', conditions: { 'มีเสียงผิดปกติ': { severity: 'warning', msg: 'มีเสียงดังผิดปกติ (เช่น เสียงเคาะ, เสียงหอน) ควรระบุแหล่งที่มาของเสียงและตรวจสอบเพื่อวินิจฉัยปัญหาแต่เนิ่นๆ' } } },
                'entry.764561274': { label: 'สภาพสายพาน (บำรุงรักษา)', type: 'radio', conditions: { 'ฉีกขาด': { severity: 'critical', msg: 'ฉีกขาดหรือมีรอยแตกร้าวรุนแรง มีความเสี่ยงสูงที่จะขาดระหว่างทำงาน ควรเปลี่ยนทันที' } } },
                'entry.1833812342': { label: 'แรงดันการชาร์จแบตเตอรี่', type: 'numeric_min', min: 12, msg: (val, min) => `มีค่า ${val}V ต่ำกว่ามาตรฐาน (ไม่ต่ำกว่า ${min}V) อาจมีปัญหากับระบบชาร์จไฟ ควรตรวจสอบไดชาร์จ` } },
                'entry.1502505224': { label: 'ทดสอบแบตเตอรี่', type: 'numeric_min', min: 12, msg: (val, min) => `มีค่า ${val}VDC ต่ำกว่ามาตรฐาน (${min}VDC) มีความเสี่ยงสูงที่จะสตาร์ทไม่ติดในภาวะฉุกเฉิน ควรพิจารณาเปลี่ยนแบตเตอรี่ใหม่` } },
                'entry.1956843408': { label: 'ฉนวนและกราวด์', type: 'radio', conditions: { 'เสื่อมสภาพ': { severity: 'critical', msg: 'ฉนวนของสายไฟเสื่อมสภาพ อาจทำให้เกิดไฟรั่วหรือลัดวงจรได้ เป็นอันตรายอย่างยิ่ง ควรเปลี่ยนสายไฟหรือแก้ไขโดยด่วน' } } },
                'entry.498232465': { label: 'อุปกรณ์ระบบความปลอดภัย', type: 'radio', conditions: { 'ไม่พร้อมใช้งาน': { severity: 'critical', msg: 'ไม่พร้อมใช้งาน ต้องรีบแก้ไขเพื่อให้ระบบสามารถป้องกันอันตรายได้อย่างสมบูรณ์เมื่อเกิดเหตุ' } } },
                'entry.1443945119': { label: 'ฟิวส์และอุปกรณ์ป้องกัน', type: 'radio', conditions: { 'ไม่พร้อมใช้งาน': { severity: 'critical', msg: 'ไม่พร้อมใช้งาน ทำให้ระบบไฟฟ้าขาดการป้องกันที่เหมาะสม เสี่ยงต่อการลัดวงจรและความเสียหายรุนแรง' } } },
            };
            const additionalMeasurementRules = {
                'entry.700036978': { label: 'Jocky Pump Start Pressure (Test)', ref_std: 'entry.170318696', type: 'numeric', tolerance: 0.1, msg: (val, std) => `ค่าที่วัดได้คือ ${val} PSI ซึ่งแตกต่างจากค่ามาตรฐานที่ตั้งไว้ (${std} PSI) เกินกว่า 10% ควรตรวจสอบความแม่นยำของ Pressure Switch` },
                'entry.174910325': { label: 'Jocky Pump Stop Pressure (Test)', ref_std: 'entry.835390568', type: 'numeric_range', msg: (val, min, max) => `ค่าที่วัดได้คือ ${val} PSI ซึ่งอยู่นอกช่วงมาตรฐานที่ตั้งไว้ (${min}-${max} PSI) ควรตรวจสอบและปรับตั้ง Pressure Switch` },
                'entry.2077235529': { label: 'Engine Pump Start Pressure (Test)', ref_std: 'entry.797055912', type: 'numeric', tolerance: 0.1, msg: (val, std) => `ค่าที่วัดได้คือ ${val} PSI ซึ่งแตกต่างจากค่ามาตรฐานที่ตั้งไว้ (${std} PSI) เกินกว่า 10% ควรตรวจสอบ Pressure Switch ของ Fire Pump` },
                'entry.491301014': { label: 'Engine Pump Max Pressure (Test)', ref_std: 'entry.1506477567', type: 'numeric_min', msg: (val, std) => `ค่าแรงดันสูงสุดที่วัดได้คือ ${val} PSI ซึ่งต่ำกว่าค่ามาตรฐานขณะทำงาน (${std} PSI) อย่างมีนัยสำคัญ อาจบ่งชี้ถึงกำลังอัดของปั๊มลดลงหรือมีจุดรั่วในระบบ ควรตรวจสอบอย่างละเอียด` },
            };

            for (const name in data) {
                const value = data[name];
                if (!value || value === '__other_option__') continue;
                const rule = rules[name];
                if (rule) {
                    if (rule.type === 'radio' && rule.conditions[value]) {
                        const cond = rule.conditions[value];
                        results[cond.severity].add(`<strong>${rule.label}:</strong> ${cond.msg}`);
                    } else {
                        const numVal = parseFloat(value);
                        if (!isNaN(numVal)) {
                            let triggered = false;
                            if (rule.type === 'numeric' && Math.abs(numVal - rule.std) > rule.std * rule.tolerance) {
                                results.warning.add(`<strong>${rule.label}:</strong> ${rule.msg(numVal, rule.std)}`);
                                triggered = true;
                            } else if (rule.type === 'numeric_range' && (numVal < rule.min || numVal > rule.max)) {
                                results.critical.add(`<strong>${rule.label}:</strong> ${rule.msg(numVal, rule.min, rule.max)}`);
                                triggered = true;
                            } else if (rule.type === 'numeric_min' && numVal < rule.min) {
                                results.warning.add(`<strong>${rule.label}:</strong> ${rule.msg(numVal, rule.min)}`);
                                triggered = true;
                            }
                            if (!triggered) results.ok.add(rule.label);
                        }
                    }
                }
                if (typeof value === 'string') {
                    const text = value.toLowerCase();
                    const keywords = { critical: ['รั่ว', 'ซึม', 'แตก', 'หัก', 'ร้าว', 'สตาร์ทไม่ติด', 'ไม่ทำงาน', 'ไฟลุก', 'ไฟไหม้'], warning: ['หย่อน', 'เสียงดัง', 'เสียงแปลก', 'สั่น', 'กระตุก', 'ร้อน', 'หลวม', 'ควันดำ', 'ควันขาว'] };
                    if (keywords.critical.some(kw => text.includes(kw))) { results.critical.add(`<strong>${getLabel(name)}:</strong> พบข้อความที่น่ากังวล "${value}" ควรตรวจสอบอย่างละเอียด`); }
                    else if (keywords.warning.some(kw => text.includes(kw))) { results.warning.add(`<strong>${getLabel(name)}:</strong> พบข้อความที่ควรให้ความสนใจ "${value}"`); }
                }
                if (name === 'entry.129342865' && value) results.info.add(`<strong>ปัญหาที่พบ (ISSUE):</strong> ${value}`);
                if (name === 'entry.690163791' && value) results.info.add(`<strong>แนวทางการแก้ไข:</strong> ${value}`);
            }

            for (const name in additionalMeasurementRules) {
                const rule = additionalMeasurementRules[name];
                const testValue = parseFloat(data[name]);
                if (isNaN(testValue)) continue;
                if (rule.type === 'numeric') {
                    const stdValue = parseFloat(data[rule.ref_std]);
                    if (!isNaN(stdValue) && Math.abs(testValue - stdValue) > stdValue * rule.tolerance) { results.warning.add(`<strong>${rule.label}:</strong> ${rule.msg(testValue, stdValue)}`); }
                } else if (rule.type === 'numeric_range') {
                    const stdValuePlaceholder = document.querySelector(`[name="${rule.ref_std}"]`)?.placeholder || '';
                    if (stdValuePlaceholder && stdValuePlaceholder.includes('-')) {
                        const match = stdValuePlaceholder.match(/(\d+)\s*-\s*(\d+)/);
                        if (match) { const [min, max] = match.slice(1).map(parseFloat); if (testValue < min || testValue > max) { results.warning.add(`<strong>${rule.label}:</strong> ${rule.msg(testValue, min, max)}`); } }
                    }
                } else if (rule.type === 'numeric_min') {
                    const stdValue = parseFloat(data[rule.ref_std]);
                    if (!isNaN(stdValue) && testValue < stdValue) { results.warning.add(`<strong>${rule.label}:</strong> ${rule.msg(testValue, stdValue)}`); }
                }
            }

            const rpm = parseFloat(data['entry.1405771031']);
            const oilPressure = parseFloat(data['entry.1301900075']);
            if (!isNaN(rpm) && !isNaN(oilPressure) && rpm > 2400 && oilPressure < 300) { results.critical.add(`<strong>การวิเคราะห์เชิงสัมพันธ์:</strong> รอบเครื่องยนต์สูง แต่แรงดันน้ำมันหล่อลื่นต่ำ เป็นสภาวะอันตรายร้ายแรงต่อเครื่องยนต์ ต้องหยุดเครื่องทันที!`); }

            const critArray = Array.from(results.critical);
            const warnArray = Array.from(results.warning);
            const infoArray = Array.from(results.info);

            let statusCard = (critArray.length > 0) ? `<div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 border-l-4 border-red-500 ai-analysis-card"><strong class="font-bold">🚨 สรุปสถานะ: พบปัญหาร้ายแรง!</strong> โปรดตรวจสอบและแก้ไขตามรายการด้านล่างโดยด่วนที่สุด</div>`
                : (warnArray.length > 0) ? `<div class="p-4 mb-4 text-sm text-amber-800 rounded-lg bg-amber-50 border-l-4 border-amber-500 ai-analysis-card"><strong class="font-bold">⚠️ สรุปสถานะ: พบข้อควรระวัง</strong> ระบบยังทำงานได้ แต่ควรบำรุงรักษาตามคำแนะนำเพื่อป้องกันปัญหาในอนาคต</div>`
                : `<div class="p-4 mb-4 text-sm text-green-800 rounded-lg bg-green-50 border-l-4 border-green-500 ai-analysis-card"><strong class="font-bold">✅ สรุปสถานะ: อยู่ในเกณฑ์ดีเยี่ยม!</strong> ไม่พบปัญหาที่น่ากังวลจากการตรวจสอบ ระบบพร้อมใช้งาน</div>`;
            
            let html = statusCard;
            let counter = 0;
            const createSection = (title, items, icon, colorClass, listType = 'disc') => {
                if (items.length === 0) return '';
                const listStyleClass = listType === 'disc' ? 'list-disc list-inside' : 'list-none';
                let sectionHTML = `<div class="ai-analysis-card ${colorClass}" style="--i: ${counter++};"><div class="p-4 rounded-lg bg-white shadow-sm"><h3 class="text-lg font-bold mb-3 flex items-center gap-2"><i class="${icon}"></i>${title}</h3><ul class="${listStyleClass} text-sm space-y-2 pl-1">`;
                items.forEach(item => { sectionHTML += (listType === 'disc') ? `<li class="flex items-start gap-3"><span class="mt-1.5 w-2 h-2 rounded-full ${colorClass === 'ai-card-critical' ? 'bg-red-500' : (colorClass === 'ai-card-warning' ? 'bg-amber-500' : 'bg-green-500')}"></span><div>${item}</div></li>` : `<li>- ${item}</li>`; });
                sectionHTML += `</ul></div></div>`;
                return sectionHTML;
            };

            html += createSection('รายการต้องแก้ไขเร่งด่วน', critArray, 'fa-solid fa-triangle-exclamation', 'ai-card-critical');
            html += createSection('ข้อควรระวังและคำแนะนำ', warnArray, 'fa-solid fa-flag', 'ai-card-warning');
            if (infoArray.length > 0) { html += createSection('บันทึกจากผู้ปฏิบัติงาน', infoArray, 'fa-solid fa-pencil', 'ai-card-info', 'none'); }
            if (critArray.length === 0 && warnArray.length === 0) { html += `<div class="text-center p-8 bg-white rounded-lg ai-analysis-card ai-card-ok" style="--i: ${counter};"><i class="fa-solid fa-party-horn text-4xl text-green-500 mb-3"></i><h3 class="text-xl font-bold text-gray-800">ยอดเยี่ยม!</h3><p class="text-gray-500">จากการวิเคราะห์ ไม่พบประเด็นที่น่ากังวล ระบบอยู่ในสถานะพร้อมใช้งาน</p></div>`; }
            
            return html;
        }

        // --- START THE APP ---
        initializeLogin();
    });
    </script>
</body>
</html>
